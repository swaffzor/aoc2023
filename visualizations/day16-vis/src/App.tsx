import React, { useEffect, useState } from 'react'
import './App.css'
import { Tile, Beam, moveBeam } from '../../../day16/solution'
import { extractDataToPointGrid } from '../../../utils'

// const energize = (grid: Tile[][], startPoint: Beam) => {
//   grid[startPoint.point.row][startPoint.point.col].z = 1
//   const currentPoint = grid[startPoint.point.row][startPoint.point.col]
//   const queue: Beam[] = [
//     {
//       point: currentPoint,
//       direction: startPoint.direction,
//     },
//   ]

//   const visitedBeams: Set<string> = new Set<string>()

//   while (queue.length > 0) {
//     const beam = queue.shift()!

//     const beamStateStr = JSON.stringify(beam)
//     if (visitedBeams.has(beamStateStr)) continue

//     visitedBeams.add(beamStateStr)

//     grid[beam.point.row][beam.point.col].z = 1

//     const nextPositions = moveBeam(beam, grid)
//     nextPositions.forEach(([point, direction]) => {
//       // grid[point.row][point.col].z = 1
//       queue.push({ point, direction })
//     })
//   }

//   return grid
//     .map((row) => row.filter((p) => p.z === 1).length)
//     .reduce((a, b) => a + b)
// }

function App() {
  // const [count, setCount] = useState(0)
  const [mirrorGrid, setMirrorGrid] = useState<Tile[][]>(
    extractDataToPointGrid(input)
  )
  // const [visitedBeams, setVisitedBeams] = useState<Set<string>>(new Set())
  const initialQueue: Beam[] = [
    {
      point: {
        row: 0,
        col: 0,
        z: 1,
        value: '\\',
      },
      direction: '>',
    },
  ]
  const [queue, setQueue] = useState<Beam[]>(initialQueue)
  const [activeTile, setActiveTile] = useState<Tile | null>({
    row: 0,
    col: 0,
    z: 1,
    value: '\\',
  })

  const [tick, setTick] = useState(0)
  useEffect(() => {
    setTimeout(() => {
      setTick(tick + 1)
    }, 100)
  }, [tick])

  useEffect(() => {
    try {
      const grid = JSON.parse(JSON.stringify(mirrorGrid)) as Tile[][]

      const myQueue: Beam[] = [...queue]
      // const myVisitedBeams: Set<string> = new Set([...visitedBeams])
      // while (queue.length > 0) {
      const beam = myQueue.shift()!
      // debugger
      // const beamStateStr = JSON.stringify(beam)
      // if (!myVisitedBeams.has(beamStateStr)) {
      //   // continue

      //   myVisitedBeams.add(beamStateStr)
      //   setVisitedBeams(myVisitedBeams)

      grid[beam.point.row][beam.point.col].z = 1

      const nextPositions = moveBeam(beam, grid)
      setMirrorGrid(
        grid.map((row) =>
          row.map((p) => {
            return {
              ...p,
              value: p.z === 1 ? '#' : p.value === '.' ? 'â€¢' : p.value,
            }
          })
        )
      )
      nextPositions.forEach(([point, direction]) => {
        // grid[point.row][point.col].z = 1
        myQueue.push({ point, direction })
        setTimeout(() => {
          setQueue(myQueue)
        }, 5)
      })
      // } else {
      //   setTimeout(() => {
      //     setQueue(myQueue)
      //   }, 5)
      // }
      console.log('tick', tick)
    } catch (e) {
      console.log(e)
    }
  }, [queue, tick])

  const cellStyles = (point: Tile) => {
    let temp = ''
    if (point.value === '#') {
      temp = 'text-red-500'
    } else if (point.value === '.') {
      temp = 'text-blue-500'
    } else {
      temp = 'text-slate-900'
    }
    return temp.concat(
      ' w-4 h-4 flex items-center justify-center cursor-pointer hover:bg-gray-200'
    )
  }

  return (
    <>
      <h1 className="text-3xl">AoC 2023 Day 16</h1>
      <h2 className="text-2xl">Beam Visualizer</h2>
      <button
        className="px-4 py-2 font-bold text-white bg-blue-500 rounded hover:bg-blue-700"
        onClick={() => {
          setMirrorGrid(extractDataToPointGrid(input))
          setQueue(initialQueue)
          // setVisitedBeams(new Set())
        }}
      >
        Reset
      </button>
      <div className="absolute left-0 top-1/2">
        <div className="container ">
          <pre>
            {JSON.stringify(activeTile, null, 2).replace(/[{},"]/g, '')}
          </pre>
        </div>
      </div>
      {mirrorGrid.map((row, i) => (
        <div
          key={`row-${i}`}
          className="flex flex-row justify-center"
        >
          {row.map((point) => (
            <div
              key={`point-${point.col}-${point.row}`}
              className={cellStyles(point)}
              onClick={() => setActiveTile(point)}
            >
              {point.value}
            </div>
          ))}
        </div>
      ))}
    </>
  )
}

export default App

const input = `\\\\.........../..............-..../....\\.......\\.................|....|..........|............-\\.....|.........\n................................../.......|..\\..........-....................\\........../../\\../..............\n.............................|...|.............\\..\\.....|.........\\....................../............/-......\n\\................\\.............|..../........\\\\.....\\\\........-.........../..\\.../...\\.......\\/.......|..|....\n......\\..............|...|..../........-../.................../....|./................./.\\........\\.|-........\n.............................-....................-............/.\\............../........\\/........|...\\......\n./........|................\\.|........\\.......\\../.-.........\\..-.............|...............................\n|....................|...............-/............-.|..|...........................|..................\\......\n................../........\\../...........|..................\\................./.......\\...-......../|........\n././...........-..|....................................-.....................|./........../..|.-..\\..|.....|..\n.............|.......................||................................../..-........./.................../...\n........-......\\............/.....-...\\..|...........\\..........-.........................\\...................\n\\/...............\\.|......................\\......\\.........\\/..........\\................./.-.../...-.....|....\n....\\........................................................\\.......-/.............\\/.........\\..............\n\\........\\.........\\..\\..|....\\..............-...../.................|.....|.................\\.-/.............\n.............................\\/..-..............\\....-...-............................................./......\n....|..../...................//.........\\.............\\......|...|....../............|.......-.|.-.-|.......\\.\n.........|..-.-........\\\\../...........|.....\\............................../....\\\\..\\......../......\\\\..|....\n.......|....................-...././...../.|../........................./...-\\...|.......|.......-....|......\\\n../.../........-......................|......-.....\\..............-../.......|./.......|.............|.......|\n........................................................./............-......\\.../........\\../../.........\\...\n........................./../.../............-.\\.........................|..............|....................|\n..-......./.--.......|.............................................\\........\\.........\\...............\\......|\n.|........................................|..........-....\\.......\\.......|................................../\n..............................................\\.....\\........|.....\\./......\\................|......../...../.\n./.\\......../..\\\\..|....-.-|..-.............................................../.\\|/........\\.........-|...|...\n........|........-.\\/................-.........-............../.|..........\\./|...--...............|..........\n.................-............./././...........|.|.....|....|......\\-....|...............|....................\n.......././..............................................|/...\\........../......./..||.\\..-...................\n............-..|....................\\..-./.........\\..........................................................\n./.-...............\\......\\...|......\\....../..........................-....................-...|......\\......\n.....././...-........................\\..../..|-.............../.......................................\\|......\n-.........................................../...............-....../.....|.........\\..-.........|.............\n....|.......\\....\\|.....\\.|....|.............\\..\\...-............../.....................\\....-...............\n.............-..-..................\\..............|..|........................-..........\\../.\\......../......\n.....|.....................\\.....\\.......\\...........\\....|.........\\.......//.................|........./....\n|.....\\-/.......|............../.....\\..........|......./......./...............\\./..........|................\n............../|.......................|....../..............-...................-...................../......\n../|....\\.......\\...............\\................-........\\..../../.................\\/.........\\....\\.........\n........-.....|.|......-...........\\............|...................\\...........|.......................|.....\n.....|....|..\\..........................|................\\..../....-..................................|.......\n..-........||/................/........|......................-....-..................../..|...../............\n............./.............\\..-.......................\\..................||.-.-..|...............\\...|...\\....\n............................\\....\\....../....\\...........-...................|....-.....|.....................\n.../...........................-..|.....|../.........\\./.................\\|..............||....|..........\\...\n.................../........\\...........\\........../............|...|\\....\\........|......-...\\.......|./...\\.\n-....|...........\\............./..\\...........||...................|.............../...............\\..........\n.........\\.........-..................../.../.......//.............-/...-.-|....\\.............................\n..-.........\\......././................-.........|-...../............|....-.............\\.....................\n......../.......|.............................\\....|......................../................................-\n..\\........./.--................/................................................................../......-...\n.../................|.\\....-.................................\\.../....................................\\.......\n.............................\\....../.|...........-............................................/....-.........\n...\\./..........-........./../...............................-..-........-....../..................-.....\\....\n.........\\........./\\........................-.-................................|.............................\n..../.|-.................................-............\\..................|.........|......./......-...........\n.-|..........................-........|...//..\\.../.........-............/|.............|..............-..\\...\n..../......|...\\..........|...........-.||....-..|.........-......../..........|................../...........\n\\.../../............./../...........\\...........\\.......................................\\./.............|.....\n.....|.../....|..............................\\........\\...................|.........|.........................\n..........|............|............./......../.../................................-.....-.........../..|.....\n......-.\\.........................|...../.....\\.....-/....-..|.\\.........\\|....-.........||...........\\.......\n..\\......\\............./...............\\-............/...|................................/...................\n.......|.|...|.|.........|..|.......-...\\.........|./..|..................-................|..........-.......\n..-\\...--..-........|......................-.....|./..............|/.................../...........\\....-.../.\n...........-...-........-..........-...........|.......-................\\.........|............-.............|\n.....|.\\..-../....\\.................../-....\\.............|......../....\\/.\\..\\...//..........|...............\n......-.-.|..|............................./.........-....|.......|......|..............................-...-.\n..|............\\...|................./\\...|........../...-.|.........\\..../.........|-...|.......\\...........-\n...................\\..../..............|...../.....\\....../.................\\..|.....................-........\n.|............-................../........-.....|..../..........................|../..\\.....\\....|............\n.............................................|..........|......-\\.............-..-........................\\...\n............./.-....|......|................................................-/|/...|../...........-...|.......\n......-................-..-...............|................-.-.............\\........|...-./................-..\n...........|...........-/........../..................../|.|...................|...................../........\n.....................................\\......................../...........|-...........-................../...\n...|.....\\.....-...../..............|.........\\....\\............-\\............\\/.........................-....\n..............-\\......-.............../...|.........................................|.....\\/..................\n.................|...|.....|.............../....\\...............-....\\..........|.-........|........../...|...\n..|...-.........\\....-.....\\.....................|...|.......-....\\....-..-......-.\\../........-../...........\n.......\\.....\\................\\......\\-................................|..\\.....//.........../..........\\.....\n........................../.-.................................\\--......../..-.................................\n.................|............|\\./....|.|..|.............//......./.......................|.....\\.....\\\\......\n./...|\\...................................../.......................\\.........|..............|....|....\\......\n......|.............................................................\\..|.................\\-..../......./......\n.....-.......|........../......./..\\...........|...........-..|......../...../................\\......\\........\n............\\....-........\\......./.......-...........................................\\........-/./...........\n|..................................-.........\\/..-....././.....\\.............../-....................\\........\n../.........-..........-....-...-.........\\/....................../.../.....\\............................-.\\.|\n........../...-..-........................-........................................./....\\.....-..............\n..|-.\\........\\....................\\.\\..........-....|.-.-...........\\..............\\..-.....|................\n..-.../......./\\.\\...\\\\.//.....|..........................\\........|.-||......................|.......\\/......\n...-........-/.............................-......................-|....\\...|..../..|.........\\...............\n.........|..|/........./.......\\....\\../\\.-..-...\\..|...../...........\\.............../..................../\\.\n.........\\.-\\|..|../...........--..........|-......|...|.................||...................................\n..................\\.....\\...........................|.............\\..|.........................|...........\\..\n....|../........../.............................|./........\\\\.....|.....|...................................|.\n-..........................................-........................-...\\..................\\.....\\......-.....\n..\\.\\......|......|........|.............-|....-.....-...........|../.-.........|........\\..\\...-...\\........\\\n.|.......-..|....|..............|.................../...............|.............................-.........//\n....................\\..\\.||./\\.......-.........-..-................../..../....................-/..........\\..\n.........\\.........|...-.....\\..........\\.\\....|.|..............|..........................................\\.|\n...|\\..|................-/..........|\\....\\/|..-...........................................\\..................\n.../...\\.|..............................\\.-...\\.........\\....../../...............-./............/............\n.....-.\\..............................................\\.|....................\\..........|...............|.....\n.....|................../|....-....-....\\..../...............\\.....|..|......./.................../........\\..\n.......................\\....................-.......-.................../..............-...\\..\\........|......\n...../................\\........../..|.../...........|........|............\\........-....-/.....\\....|.........\n.\\\\.\\............|..................................................|......\\/..........................\\......\n....|........../...../...-.................|......|..........-....................................../.../.....`
